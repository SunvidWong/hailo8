{% extends "base.html" %}

{% block title %}å®‰è£…ä¸­å¿ƒ - Frigate Setup Wizard{% endblock %}

{% block extra_css %}
<style>
.install-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.install-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--bs-primary);
}

.install-option {
    cursor: pointer;
    transition: all 0.2s ease;
}

.install-option:hover {
    background-color: var(--bs-light);
}

.install-option.selected {
    background-color: var(--bs-primary);
    color: white;
}

.feature-list {
    list-style: none;
    padding: 0;
}

.feature-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--bs-border-color);
}

.feature-list li:last-child {
    border-bottom: none;
}

.feature-list li i {
    color: var(--bs-success);
    margin-right: 0.5rem;
}

.progress-container {
    display: none;
}

.install-logs {
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">ğŸš€ å®‰è£…ä¸­å¿ƒ</h1>
                    <p class="text-muted mb-0">é€‰æ‹©æ‚¨éœ€è¦çš„å®‰è£…é€‰é¡¹</p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary" onclick="refreshPage()">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å®‰è£…é€‰é¡¹å¡ç‰‡ -->
    <div class="row g-4 mb-4">
        <!-- Hailo8 TPU å®‰è£… -->
        <div class="col-lg-4 col-md-6">
            <div class="card install-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-microchip"></i> Hailo8 TPU
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">å®‰è£…Hailo8 TPUé©±åŠ¨å’Œè¿è¡Œæ—¶ç¯å¢ƒï¼Œæä¾›é«˜æ€§èƒ½AIæ¨ç†åŠ é€Ÿã€‚</p>
                    
                    <ul class="feature-list">
                        <li><i class="fas fa-check"></i> è‡ªåŠ¨æ£€æµ‹ç¡¬ä»¶</li>
                        <li><i class="fas fa-check"></i> é©±åŠ¨ç¨‹åºå®‰è£…</li>
                        <li><i class="fas fa-check"></i> è¿è¡Œæ—¶ç¯å¢ƒé…ç½®</li>
                        <li><i class="fas fa-check"></i> æ€§èƒ½ä¼˜åŒ–</li>
                    </ul>
                    
                    <div class="mt-3">
                        <span class="badge bg-info">ç¡¬ä»¶åŠ é€Ÿ</span>
                        <span class="badge bg-success">é«˜æ€§èƒ½</span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary w-100" onclick="startHailo8Install()">
                        <i class="fas fa-download"></i> å®‰è£… Hailo8
                    </button>
                </div>
            </div>
        </div>

        <!-- Frigate NVR å®‰è£… -->
        <div class="col-lg-4 col-md-6">
            <div class="card install-card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-video"></i> Frigate NVR
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">å®‰è£…Frigateç½‘ç»œè§†é¢‘å½•åƒæœºï¼Œæ”¯æŒAIç›®æ ‡æ£€æµ‹å’Œæ™ºèƒ½ç›‘æ§ã€‚</p>
                    
                    <ul class="feature-list">
                        <li><i class="fas fa-check"></i> Dockerå®¹å™¨éƒ¨ç½²</li>
                        <li><i class="fas fa-check"></i> AIç›®æ ‡æ£€æµ‹</li>
                        <li><i class="fas fa-check"></i> å®æ—¶ç›‘æ§</li>
                        <li><i class="fas fa-check"></i> å½•åƒç®¡ç†</li>
                    </ul>
                    
                    <div class="mt-3">
                        <span class="badge bg-primary">è§†é¢‘ç›‘æ§</span>
                        <span class="badge bg-warning">AIæ£€æµ‹</span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-success w-100" onclick="startFrigateInstall()">
                        <i class="fas fa-download"></i> å®‰è£… Frigate
                    </button>
                </div>
            </div>
        </div>

        <!-- å®Œæ•´å®‰è£… -->
        <div class="col-lg-4 col-md-6">
            <div class="card install-card h-100 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star"></i> å®Œæ•´å®‰è£…
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">ä¸€é”®å®‰è£…Hailo8 TPU + Frigate NVRï¼Œè·å¾—æœ€ä½³çš„AIç›‘æ§ä½“éªŒã€‚</p>
                    
                    <ul class="feature-list">
                        <li><i class="fas fa-check"></i> Hailo8 TPUæ”¯æŒ</li>
                        <li><i class="fas fa-check"></i> Frigate NVR</li>
                        <li><i class="fas fa-check"></i> è‡ªåŠ¨é…ç½®é›†æˆ</li>
                        <li><i class="fas fa-check"></i> æ€§èƒ½ä¼˜åŒ–</li>
                    </ul>
                    
                    <div class="mt-3">
                        <span class="badge bg-danger">æ¨è</span>
                        <span class="badge bg-info">ä¸€é”®å®‰è£…</span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-warning w-100" onclick="startFullInstall()">
                        <i class="fas fa-magic"></i> ä¸€é”®å®‰è£…
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å®‰è£…è¿›åº¦åŒºåŸŸ -->
    <div class="row" id="progressContainer" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog fa-spin"></i> å®‰è£…è¿›åº¦
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="installStatus">å‡†å¤‡å®‰è£…...</span>
                            <span id="installProgress">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">å®‰è£…æ—¥å¿—</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div id="installLogs" class="install-logs bg-dark text-light p-2 rounded">
                                        <div class="text-muted">ç­‰å¾…å®‰è£…å¼€å§‹...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">å®‰è£…ä¿¡æ¯</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>ä»»åŠ¡ID:</strong>
                                        <span id="taskId" class="text-muted">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>å¼€å§‹æ—¶é—´:</strong>
                                        <span id="startTime" class="text-muted">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>è¿è¡Œæ—¶é—´:</strong>
                                        <span id="duration" class="text-muted">-</span>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-danger btn-sm w-100" id="cancelBtn" onclick="cancelInstall()">
                                            <i class="fas fa-stop"></i> å–æ¶ˆå®‰è£…
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å®‰è£…å†å² -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history"></i> å®‰è£…å†å²
                    </h5>
                </div>
                <div class="card-body">
                    <div id="installHistory">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å®‰è£…é€‰é¡¹æ¨¡æ€æ¡† -->
<div class="modal fade" id="installOptionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å®‰è£…é€‰é¡¹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="installOptionsForm">
                    <div class="mb-3">
                        <label class="form-label">å®‰è£…ç±»å‹</label>
                        <div id="installTypeOptions">
                            <!-- åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="forceReinstall">
                            <label class="form-check-label" for="forceReinstall">
                                å¼ºåˆ¶é‡æ–°å®‰è£…ï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="advancedOptions" style="display: none;">
                        <label class="form-label">é«˜çº§é€‰é¡¹</label>
                        <textarea class="form-control" id="customOptions" rows="3" 
                                  placeholder="JSONæ ¼å¼çš„è‡ªå®šä¹‰é€‰é¡¹"></textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showAdvanced" 
                               onchange="toggleAdvancedOptions()">
                        <label class="form-check-label" for="showAdvanced">
                            æ˜¾ç¤ºé«˜çº§é€‰é¡¹
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmInstall()">å¼€å§‹å®‰è£…</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentInstallType = '';
let currentTaskId = '';
let installStatusInterval = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
$(document).ready(function() {
    loadInstallHistory();
});

// å¼€å§‹Hailo8å®‰è£…
function startHailo8Install() {
    currentInstallType = 'hailo8';
    showInstallOptions('Hailo8 TPU', [
        {value: 'standard', label: 'æ ‡å‡†å®‰è£…', description: 'å®‰è£…åŸºæœ¬çš„Hailo8é©±åŠ¨å’Œè¿è¡Œæ—¶'},
        {value: 'development', label: 'å¼€å‘ç‰ˆå®‰è£…', description: 'åŒ…å«å¼€å‘å·¥å…·å’Œç¤ºä¾‹ä»£ç '},
        {value: 'minimal', label: 'æœ€å°å®‰è£…', description: 'ä»…å®‰è£…å¿…è¦çš„è¿è¡Œæ—¶ç»„ä»¶'}
    ]);
}

// å¼€å§‹Frigateå®‰è£…
function startFrigateInstall() {
    currentInstallType = 'frigate';
    showInstallOptions('Frigate NVR', [
        {value: 'standard', label: 'æ ‡å‡†å®‰è£…', description: 'åŸºæœ¬çš„Frigate NVRåŠŸèƒ½'},
        {value: 'hailo8', label: 'Hailo8å¢å¼ºç‰ˆ', description: 'é›†æˆHailo8 TPUåŠ é€Ÿ'},
        {value: 'coral', label: 'Coralå¢å¼ºç‰ˆ', description: 'é›†æˆGoogle CoralåŠ é€Ÿ'}
    ]);
}

// å¼€å§‹å®Œæ•´å®‰è£…
function startFullInstall() {
    currentInstallType = 'full';
    showInstallOptions('å®Œæ•´å®‰è£…', [
        {value: 'recommended', label: 'æ¨èé…ç½®', description: 'Hailo8 + Frigateçš„æœ€ä½³é…ç½®'},
        {value: 'custom', label: 'è‡ªå®šä¹‰é…ç½®', description: 'è‡ªå®šä¹‰å®‰è£…é€‰é¡¹'}
    ]);
}

// æ˜¾ç¤ºå®‰è£…é€‰é¡¹
function showInstallOptions(title, options) {
    $('#installOptionsModal .modal-title').text(title + ' - å®‰è£…é€‰é¡¹');
    
    let optionsHtml = '';
    options.forEach((option, index) => {
        optionsHtml += `
            <div class="install-option p-3 border rounded mb-2 ${index === 0 ? 'selected' : ''}" 
                 onclick="selectInstallOption(this, '${option.value}')">
                <div class="d-flex align-items-center">
                    <input type="radio" name="installType" value="${option.value}" 
                           ${index === 0 ? 'checked' : ''} class="me-2">
                    <div>
                        <strong>${option.label}</strong>
                        <div class="text-muted small">${option.description}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    $('#installTypeOptions').html(optionsHtml);
    $('#installOptionsModal').modal('show');
}

// é€‰æ‹©å®‰è£…é€‰é¡¹
function selectInstallOption(element, value) {
    $('.install-option').removeClass('selected');
    $(element).addClass('selected');
    $(element).find('input[type="radio"]').prop('checked', true);
}

// åˆ‡æ¢é«˜çº§é€‰é¡¹
function toggleAdvancedOptions() {
    if ($('#showAdvanced').is(':checked')) {
        $('#advancedOptions').show();
    } else {
        $('#advancedOptions').hide();
    }
}

// ç¡®è®¤å®‰è£…
function confirmInstall() {
    const selectedType = $('input[name="installType"]:checked').val();
    const forceReinstall = $('#forceReinstall').is(':checked');
    const customOptions = $('#customOptions').val();
    
    let options = {
        type: selectedType,
        force: forceReinstall
    };
    
    // è§£æè‡ªå®šä¹‰é€‰é¡¹
    if (customOptions.trim()) {
        try {
            const custom = JSON.parse(customOptions);
            options = {...options, ...custom};
        } catch (e) {
            showToast('è‡ªå®šä¹‰é€‰é¡¹æ ¼å¼é”™è¯¯', 'error');
            return;
        }
    }
    
    // éšè—æ¨¡æ€æ¡†
    $('#installOptionsModal').modal('hide');
    
    // å¼€å§‹å®‰è£…
    startInstallation(currentInstallType, options);
}

// å¼€å§‹å®‰è£…
function startInstallation(type, options) {
    showProgressContainer();
    
    $.ajax({
        url: '/install/api/start',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            type: type,
            options: options
        }),
        success: function(response) {
            if (response.success) {
                currentTaskId = response.task_id;
                $('#taskId').text(currentTaskId);
                $('#startTime').text(new Date().toLocaleString());
                
                showToast(response.message, 'success');
                startStatusMonitoring();
            } else {
                showToast(response.error, 'error');
                hideProgressContainer();
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'å¯åŠ¨å®‰è£…å¤±è´¥';
            showToast(error, 'error');
            hideProgressContainer();
        }
    });
}

// å¼€å§‹çŠ¶æ€ç›‘æ§
function startStatusMonitoring() {
    if (installStatusInterval) {
        clearInterval(installStatusInterval);
    }
    
    installStatusInterval = setInterval(function() {
        if (currentTaskId) {
            updateInstallStatus();
        }
    }, 2000);
}

// æ›´æ–°å®‰è£…çŠ¶æ€
function updateInstallStatus() {
    $.ajax({
        url: `/install/api/status/${currentTaskId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const data = response.data;
                
                // æ›´æ–°è¿›åº¦
                $('#installProgress').text(data.progress + '%');
                $('#progressBar').css('width', data.progress + '%');
                $('#installStatus').text(data.message);
                
                // æ›´æ–°è¿è¡Œæ—¶é—´
                if (data.current_duration) {
                    $('#duration').text(formatDuration(data.current_duration));
                }
                
                // æ›´æ–°æ—¥å¿—
                updateInstallLogs(data.logs);
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                if (data.status === 'completed') {
                    $('#progressBar').removeClass('progress-bar-animated progress-bar-striped')
                                   .addClass('bg-success');
                    $('#cancelBtn').hide();
                    showToast('å®‰è£…å®Œæˆï¼', 'success');
                    stopStatusMonitoring();
                    loadInstallHistory();
                } else if (data.status === 'failed') {
                    $('#progressBar').removeClass('progress-bar-animated progress-bar-striped')
                                   .addClass('bg-danger');
                    $('#cancelBtn').hide();
                    showToast('å®‰è£…å¤±è´¥: ' + data.message, 'error');
                    stopStatusMonitoring();
                    loadInstallHistory();
                } else if (data.status === 'cancelled') {
                    $('#progressBar').removeClass('progress-bar-animated progress-bar-striped')
                                   .addClass('bg-warning');
                    $('#cancelBtn').hide();
                    showToast('å®‰è£…å·²å–æ¶ˆ', 'warning');
                    stopStatusMonitoring();
                    loadInstallHistory();
                }
            }
        },
        error: function() {
            // é™é»˜å¤„ç†é”™è¯¯ï¼Œé¿å…é¢‘ç¹æç¤º
        }
    });
}

// æ›´æ–°å®‰è£…æ—¥å¿—
function updateInstallLogs(logs) {
    if (!logs || logs.length === 0) return;
    
    const logsContainer = $('#installLogs');
    let logsHtml = '';
    
    logs.slice(-50).forEach(log => {
        const time = new Date(log.timestamp).toLocaleTimeString();
        const levelClass = log.level === 'error' ? 'text-danger' : 
                          log.level === 'success' ? 'text-success' : 
                          log.level === 'warning' ? 'text-warning' : 'text-light';
        
        logsHtml += `<div class="${levelClass}">[${time}] ${log.message}</div>`;
    });
    
    logsContainer.html(logsHtml);
    logsContainer.scrollTop(logsContainer[0].scrollHeight);
}

// å–æ¶ˆå®‰è£…
function cancelInstall() {
    if (!currentTaskId) return;
    
    if (confirm('ç¡®å®šè¦å–æ¶ˆå½“å‰å®‰è£…å—ï¼Ÿ')) {
        $.ajax({
            url: `/install/api/cancel/${currentTaskId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'warning');
                } else {
                    showToast(response.error, 'error');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'å–æ¶ˆå®‰è£…å¤±è´¥';
                showToast(error, 'error');
            }
        });
    }
}

// åœæ­¢çŠ¶æ€ç›‘æ§
function stopStatusMonitoring() {
    if (installStatusInterval) {
        clearInterval(installStatusInterval);
        installStatusInterval = null;
    }
}

// æ˜¾ç¤ºè¿›åº¦å®¹å™¨
function showProgressContainer() {
    $('#progressContainer').show();
    $('html, body').animate({
        scrollTop: $('#progressContainer').offset().top - 100
    }, 500);
}

// éšè—è¿›åº¦å®¹å™¨
function hideProgressContainer() {
    $('#progressContainer').hide();
    stopStatusMonitoring();
    currentTaskId = '';
}

// åŠ è½½å®‰è£…å†å²
function loadInstallHistory() {
    $.ajax({
        url: '/install/api/history',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                displayInstallHistory(response.data);
            } else {
                $('#installHistory').html('<div class="text-danger">åŠ è½½å†å²å¤±è´¥</div>');
            }
        },
        error: function() {
            $('#installHistory').html('<div class="text-danger">åŠ è½½å†å²å¤±è´¥</div>');
        }
    });
}

// æ˜¾ç¤ºå®‰è£…å†å²
function displayInstallHistory(history) {
    if (history.length === 0) {
        $('#installHistory').html('<div class="text-muted">æš‚æ— å®‰è£…å†å²</div>');
        return;
    }
    
    let historyHtml = '<div class="table-responsive"><table class="table table-hover">';
    historyHtml += '<thead><tr><th>ä»»åŠ¡ID</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>å¼€å§‹æ—¶é—´</th><th>ç»“æŸæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
    
    history.forEach(item => {
        const statusClass = item.status === 'completed' ? 'success' : 
                           item.status === 'failed' ? 'danger' : 'warning';
        const statusText = item.status === 'completed' ? 'å®Œæˆ' : 
                          item.status === 'failed' ? 'å¤±è´¥' : 'å–æ¶ˆ';
        
        historyHtml += `
            <tr>
                <td><code>${item.id}</code></td>
                <td><span class="badge bg-primary">${item.type}</span></td>
                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                <td>${item.start_time ? new Date(item.start_time).toLocaleString() : '-'}</td>
                <td>${item.end_time ? new Date(item.end_time).toLocaleString() : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewInstallLogs('${item.id}')">
                        <i class="fas fa-eye"></i> æŸ¥çœ‹æ—¥å¿—
                    </button>
                </td>
            </tr>
        `;
    });
    
    historyHtml += '</tbody></table></div>';
    $('#installHistory').html(historyHtml);
}

// æŸ¥çœ‹å®‰è£…æ—¥å¿—
function viewInstallLogs(taskId) {
    window.open(`/install/api/logs/${taskId}`, '_blank');
}

// æ ¼å¼åŒ–æŒç»­æ—¶é—´
function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// åˆ·æ–°é¡µé¢
function refreshPage() {
    location.reload();
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†
$(window).on('beforeunload', function() {
    stopStatusMonitoring();
});
</script>
{% endblock %}